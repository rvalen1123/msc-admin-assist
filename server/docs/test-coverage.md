# Test Coverage Configuration & Maintenance

This document provides detailed information about the test coverage configuration for the MSC Wound Care Admin Portal backend.

## Coverage Measurement

We use Jest's built-in coverage mechanism which is based on Istanbul. This allows us to:

- Measure code coverage during test execution
- Set coverage thresholds to maintain quality
- Generate detailed reports for analysis
- Track coverage changes over time

## Coverage Configuration

The coverage configuration is defined in `jest.config.js` and includes:

### Coverage Collection

```javascript
collectCoverage: true,
collectCoverageFrom: [
  '<rootDir>/src/modules/customers/**/*.ts',
  '<rootDir>/src/modules/products/**/*.ts',
  '<rootDir>/src/modules/forms/**/*.ts',
  '<rootDir>/src/modules/orders/**/*.ts',
  '<rootDir>/src/common/testing/**/*.ts',
  '<rootDir>/src/modules/auth/decorators/**/*.ts',
  '<rootDir>/src/modules/auth/guards/**/*.ts',
  '!<rootDir>/src/**/*.d.ts',
  '!<rootDir>/src/**/*.module.ts',
  '!<rootDir>/src/**/*.dto.ts',
  '!<rootDir>/src/**/*.entity.ts',
  '!<rootDir>/src/**/*.mock.ts',
  '!<rootDir>/src/**/*-test.ts',
  '!<rootDir>/src/**/index.ts',
],
```

We focus on collecting coverage from the most critical modules in the application. DTOs, entities, and other supporting files are excluded from coverage measurements to focus on business logic.

### Coverage Reporting

```javascript
coverageDirectory: 'coverage',
coverageReporters: ['json', 'lcov', 'text', 'clover', 'json-summary'],
```

We generate multiple report formats:
- `json`: Used for detailed metrics
- `lcov`: For integration with external tools and IDEs
- `text`: For console output
- `clover`: XML format for CI integration
- `json-summary`: Used by badge generation script

### Coverage Thresholds

```javascript
coverageThreshold: {
  global: {
    statements: 80,
    branches: 40,
    functions: 70,
    lines: 80,
  },
  './src/modules/customers/': {
    statements: 90,
    branches: 70,
    functions: 90,
    lines: 90,
  },
  // ... other modules
},
```

We maintain different thresholds for different parts of the application:
- **Global**: Minimum level for the entire codebase
- **Per-module**: Higher standards for critical business modules

## CI Integration

Our CI pipeline automatically runs tests with coverage and uploads the results to Codecov.

### Workflow Configuration

The relevant section from `.github/workflows/ci.yml`:

```yaml
- name: Run tests with coverage
  run: |
    cd server
    npm run test:ci
  env:
    # ... environment variables

- name: Upload coverage to Codecov
  uses: codecov/codecov-action@v3
  with:
    directory: ./server/coverage/
    flags: unit-tests
    name: unit-test-coverage
    fail_ci_if_error: false

- name: Upload E2E coverage to Codecov
  uses: codecov/codecov-action@v3
  with:
    directory: ./server/coverage-e2e/
    flags: e2e-tests
    name: e2e-test-coverage
    fail_ci_if_error: false

- name: Generate coverage badges
  run: |
    cd server
    npm run test:badge
```

This setup ensures:
1. Tests are run with coverage metrics
2. Coverage data is uploaded to Codecov
3. Coverage badges are updated in the README

## Coverage Badges

We use dynamic badges to show current coverage metrics directly in the README. These badges are updated automatically by the CI pipeline.

The badges are generated using a custom script at `scripts/generate-badges.js`, which:
1. Reads the coverage summary generated by Jest
2. Formats the metrics into badges with appropriate colors
3. Updates the README with the new badges

## Maintaining Coverage

To maintain and improve code coverage:

1. **Always add tests for new code**: Every new feature or bug fix should include tests.

2. **Follow TDD when possible**: Writing tests before implementation helps ensure good coverage.

3. **Run coverage reports locally**: Before submitting a PR, check that coverage meets thresholds:
   ```bash
   npm run test:cov
   ```

4. **Focus on critical paths**: Prioritize coverage of business logic and error-handling code.

5. **Regularly review uncovered code**: The coverage reports highlight code that isn't tested.

## Troubleshooting

### Coverage thresholds not being met

If coverage thresholds are not being met:

1. Check the coverage report to identify uncovered code
2. Add tests for the uncovered code
3. If the uncovered code cannot be reasonably tested (e.g., error handling for extreme edge cases), consider adjusting thresholds for that specific module

### Coverage reports not generating correctly

If coverage reports are not generating correctly:

1. Check that the `collectCoverageFrom` paths are correct
2. Ensure no `.gitignore` or `.eslintignore` rules are excluding test files
3. Verify that the coverage directory is writable

## Future Improvements

Planned improvements to our coverage setup:

1. **Integration with IDE**: Configure IDE plugins to show coverage inline
2. **Per-PR coverage reports**: Add Codecov GitHub integration to show coverage changes per PR
3. **Trend analysis**: Track coverage trends over time to identify areas for improvement 